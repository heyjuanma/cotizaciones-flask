<!DOCTYPE html>
<html>
<head>
    <title>Cotizaciones</title>
</head>
<body>
<h2>Nueva Cotización</h2>

<form method="POST" onsubmit="return prepararItems()">

Nombre cliente: <input name="nombre_cliente"><br>
Email: <input name="email"><br>
Teléfono: <input name="telefono"><br><br>

Título proyecto: <input name="titulo_proyecto"><br>
Descripción: <textarea name="descripcion"></textarea><br>
Instalado: <input name="instalado"><br>
Diseño: <input name="diseno"><br><br>

<table border="1" id="tabla">
<tr>
<th>Cantidad</th>
<th>Detalle</th>
<th>Precio</th>
<th>Monto</th>
</tr>
<tr>
<td><input oninput="recalcular()"></td>
<td><input></td>
<td><input oninput="recalcular()"></td>
<td>0</td>
</tr>
</table>

<button type="button" onclick="agregarFila()">Agregar fila</button>
<br><br>

Subtotal: <span id="subtotal">0</span><br>
Total (13%): <span id="total">0</span><br>

<input type="hidden" name="items" id="items">

<br>
<button type="submit">Crear Cotización</button>
</form>

<hr>

<h2>Cotizaciones Guardadas</h2>
<ul>
{% for c in cotizaciones %}
<li>
{{ c.numero_registro }} - {{ c.nombre_cliente }} -
<a href="/download/{{ c.id }}">Descargar PDF</a>
</li>
{% endfor %}
</ul>

<script>
function agregarFila() {
    let t = document.getElementById("tabla");
    let r = t.insertRow();
    for (let i = 0; i < 4; i++) r.insertCell();
    r.cells[0].innerHTML = "<input oninput='recalcular()'>";
    r.cells[1].innerHTML = "<input>";
    r.cells[2].innerHTML = "<input oninput='recalcular()'>";
    r.cells[3].innerText = "0";
}

function recalcular() {
    let rows = document.querySelectorAll("#tabla tr");
    let subtotal = 0;

    rows.forEach((r, i) => {
        if (i === 0) return;

        let c = Number(r.cells[0].querySelector("input")?.value || 0);
        let p = Number(r.cells[2].querySelector("input")?.value || 0);

        let monto = c * p;
        r.cells[3].innerText = monto;

        subtotal += monto;
    });

    document.getElementById("subtotal").innerText = subtotal;
    document.getElementById("total").innerText = (subtotal * 1.13).toFixed(2);
}

function prepararItems() {
    let rows = document.querySelectorAll("#tabla tr");
    let items = [];
    let subtotal = 0;

    rows.forEach((r, i) => {
        if (i === 0) return;

        let c = Number(r.cells[0].querySelector("input")?.value || 0);
        let d = r.cells[1].querySelector("input")?.value || "";
        let p = Number(r.cells[2].querySelector("input")?.value || 0);
        if (!c || !p) return;

        let monto = c * p;
        subtotal += monto;

        items.push({
            cantidad: c,
            detalle: d,
            precio: p,
            monto: monto
        });
    });

    document.getElementById("items").value = JSON.stringify(items);
    return true;
}
</script>
</body>
</html>

